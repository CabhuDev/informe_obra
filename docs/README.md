# üìã Sistema de Informes de Obra - Obratec.app

Sistema automatizado para generar informes semanales de obra con integraci√≥n de IA, transcripci√≥n de audio y env√≠o autom√°tico por email.

[![Deploy Status](https://img.shields.io/badge/deploy-ready-green.svg)](https://obratec.app)
[![Docker](https://img.shields.io/badge/docker-ready-blue.svg)](./docker-compose.vps.yml)
[![Security](https://img.shields.io/badge/security-hardened-red.svg)](./n8n/security.json)

## ‚ú® Caracter√≠sticas

- **üì± Formulario web responsive** - Compatible con m√≥viles y tablets
- **üéôÔ∏è Grabaci√≥n de audio** - Observaciones de voz con transcripci√≥n autom√°tica
- **ü§ñ IA integrada** - Generaci√≥n autom√°tica de res√∫menes con OpenAI
- **üìß Env√≠o autom√°tico** - Email con PDF adjunto usando Gmail OAuth2
- **üîí Seguridad avanzada** - N8N completamente protegido y no accesible
- **üê≥ Docker ready** - Despliegue f√°cil con Docker Compose
- **‚ö° Alta disponibilidad** - Configurado para VPS de producci√≥n

## üõ†Ô∏è Arquitectura del Sistema

```
Frontend (Puerto 3000) ‚Üí N8N Webhook ‚Üí OpenAI API ‚Üí Gmail API
      ‚Üì                      ‚Üì             ‚Üì           ‚Üì
   Nginx Proxy          Procesamiento  Transcripci√≥n  Email
  (obratec.app)         Workflows      y An√°lisis    Autom√°tico
```

## üöÄ Despliegue R√°pido

### Opci√≥n 1: Despliegue en VPS (Recomendado)

```bash
# 1. Clona el repositorio
git clone https://github.com/tu-usuario/informe_obra.git
cd informe_obra

# 2. Configura variables de entorno
cp .env.example .env
# Edita .env con tus claves API

# 3. Ejecuta el script de despliegue
chmod +x deploy-vps.sh
./deploy-vps.sh
```

### Opci√≥n 2: Docker Compose Local

```bash
# 1. Clona y configura
git clone https://github.com/tu-usuario/informe_obra.git
cd informe_obra
cp .env.example .env

# 2. Ejecuta con Docker
docker-compose -f docker-compose.vps.yml up -d

# 3. Accede a:
# - Aplicaci√≥n: http://localhost:3000
# - Webhook: http://localhost:3000/webhook/form-obra
```

## üìã Configuraci√≥n Requerida

### 1. Variables de Entorno (.env)

```env
# Configuraci√≥n b√°sica
NODE_ENV=production
N8N_HOST=tu-dominio.com
N8N_PROTOCOL=https
WEBHOOK_URL=https://tu-dominio.com/webhook/form-obra

# Seguridad N8N
N8N_BASIC_AUTH_ACTIVE=true
N8N_BASIC_AUTH_USER=admin
N8N_BASIC_AUTH_PASSWORD=tu_password_seguro
N8N_ENCRYPTION_KEY=clave_32_caracteres_aleatoria

# APIs necesarias
OPENAI_API_KEY=sk-proj-tu_clave_openai
GOOGLE_CLIENT_ID=tu_google_client_id
GOOGLE_CLIENT_SECRET=tu_google_client_secret
GMAIL_USER=tu_email@gmail.com
GMAIL_PASSWORD=tu_app_password
```

### 2. Configuraci√≥n de Google APIs

1. **Google Cloud Console**:
   - Crear proyecto nuevo
   - Habilitar Gmail API
   - Crear credenciales OAuth 2.0
   - Configurar pantalla de consentimiento

2. **OpenAI API**:
   - Crear cuenta en OpenAI
   - Generar API key
   - Configurar l√≠mites de uso

## üìÅ Estructura del Proyecto

```
informe_obra/
‚îú‚îÄ‚îÄ üìÑ public/                 # Frontend
‚îÇ   ‚îú‚îÄ‚îÄ index.html            # Formulario principal
‚îÇ   ‚îú‚îÄ‚îÄ js/script.js          # L√≥gica del formulario
‚îÇ   ‚îî‚îÄ‚îÄ css/style.css         # Estilos
‚îú‚îÄ‚îÄ üîß n8n/                   # Workflows N8N
‚îÇ   ‚îú‚îÄ‚îÄ workflows/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ informe_obra_n8n_workflow.json
‚îÇ   ‚îî‚îÄ‚îÄ security.json         # Configuraci√≥n de seguridad
‚îú‚îÄ‚îÄ üê≥ Docker/
‚îÇ   ‚îú‚îÄ‚îÄ docker-compose.vps.yml
‚îÇ   ‚îî‚îÄ‚îÄ Dockerfile
‚îú‚îÄ‚îÄ üõ°Ô∏è Seguridad/
‚îÇ   ‚îú‚îÄ‚îÄ security-monitor.sh   # Monitor de seguridad
‚îÇ   ‚îî‚îÄ‚îÄ server.js            # Proxy seguro
‚îî‚îÄ‚îÄ üìö Documentaci√≥n/
    ‚îú‚îÄ‚îÄ DEPLOY_GUIDE.md
    ‚îî‚îÄ‚îÄ README.md
```

## üîê Caracter√≠sticas de Seguridad

### N8N Completamente Protegido

- ‚úÖ **Puerto 5678 no expuesto** - Solo comunicaci√≥n interna
- ‚úÖ **UI bloqueada** - Imposible acceder a la interfaz administrativa
- ‚úÖ **Autenticaci√≥n obligatoria** - Usuario y contrase√±a para acceso
- ‚úÖ **Funciones peligrosas deshabilitadas** - No ejecuci√≥n de comandos del sistema
- ‚úÖ **Solo webhooks permitidos** - Endpoints REST bloqueados

### Proxy de Seguridad

```javascript
// Middleware que bloquea acceso a rutas administrativas
const blockedPaths = ['/n8n/', '/editor/', '/workflows/', '/credentials/'];
// Solo permite /webhook/ para el funcionamiento de la app
```

## üö¶ Verificaci√≥n del Sistema

### Script de Monitoreo

```bash
# Ejecutar verificaci√≥n completa
./security-monitor.sh

# Salida esperada:
# ‚úÖ Puerto 5678 seguro (no expuesto p√∫blicamente)
# ‚úÖ Autenticaci√≥n b√°sica activada
# ‚úÖ Funciones peligrosas bloqueadas
# ‚úÖ UI administrativa bloqueada
```

### Prueba Manual

```bash
# Probar webhook (debe funcionar)
curl -X POST http://localhost:3000/webhook/form-obra \
  -H "Content-Type: application/json" \
  -d '{"test": "true"}'

# Probar acceso a UI (debe estar bloqueado)
curl http://localhost:3000/n8n/
# Respuesta esperada: 403 Forbidden
```

## üìß Workflow del Sistema

1. **Usuario completa formulario** ‚Üí Datos + audio
2. **Webhook recibe datos** ‚Üí Activa workflow N8N
3. **N8N procesa informaci√≥n**:
   - Transcribe audio con OpenAI
   - Genera resumen inteligente
   - Crea HTML formateado
   - Convierte a PDF
4. **Env√≠a email autom√°tico** ‚Üí Gmail con PDF adjunto

## üîÑ Mantenimiento

### Actualizaciones

```bash
# Actualizar c√≥digo
git pull origin main

# Reconstruir contenedores
docker-compose -f docker-compose.vps.yml down
docker-compose -f docker-compose.vps.yml up --build -d
```

### Logs y Debugging

```bash
# Ver logs de la aplicaci√≥n
docker logs -f obratec-app

# Ver logs de N8N
docker logs -f obratec-n8n

# Verificar estado de contenedores
docker ps
```

### Backup

```bash
# Backup de workflows N8N
docker exec obratec-n8n cp -r /home/node/.n8n/workflows /backup/

# Backup de base de datos SQLite
docker exec obratec-n8n cp /home/node/.n8n/database.sqlite /backup/
```

## üêõ Soluci√≥n de Problemas

### Problemas Comunes

| Problema | Soluci√≥n |
|----------|----------|
| CORS Error | Verificar que ambos servicios usen el mismo hostname |
| Audio no se env√≠a | Comprobar que el input type="file" est√© configurado |
| Email no llega | Verificar credenciales Gmail y app password |
| N8N no responde | Verificar que el contenedor est√© corriendo |

### Comandos de Diagn√≥stico

```bash
# Verificar puertos
netstat -tlnp | grep :3000
netstat -tlnp | grep :5678

# Verificar DNS
nslookup tu-dominio.com

# Verificar SSL
openssl s_client -connect tu-dominio.com:443
```

## üìä M√©tricas y Monitoreo

### Archivos de Log

- `/var/log/nginx/access.log` - Accesos web
- `docker logs obratec-app` - Aplicaci√≥n principal
- `docker logs obratec-n8n` - Workflows N8N

### Alertas Autom√°ticas

El sistema registra y alerta sobre:
- Intentos de acceso a rutas bloqueadas
- Errores en el procesamiento de formularios
- Fallos en el env√≠o de emails
- Problemas de conectividad con APIs

## ü§ù Contribuir

1. Fork el repositorio
2. Crea una rama para tu feature (`git checkout -b feature/AmazingFeature`)
3. Commit tus cambios (`git commit -m 'Add some AmazingFeature'`)
4. Push a la rama (`git push origin feature/AmazingFeature`)
5. Abre un Pull Request

## üìÑ Licencia

Este proyecto est√° bajo la Licencia MIT - ver el archivo [LICENSE](LICENSE) para m√°s detalles.

## üìû Soporte

- üìß Email: soporte@obratec.app
- üìö Documentaci√≥n: [Wiki del proyecto](https://github.com/tu-usuario/informe_obra/wiki)
- üêõ Issues: [GitHub Issues](https://github.com/tu-usuario/informe_obra/issues)

---

**üîó Enlaces √ötiles:**
- [Documentaci√≥n N8N](https://docs.n8n.io/)
- [API OpenAI](https://platform.openai.com/docs/)
- [Gmail API](https://developers.google.com/gmail/api)
- [Docker Compose](https://docs.docker.com/compose/)

> **‚ö†Ô∏è Nota**: Este sistema est√° dise√±ado para ser completamente seguro. N8N no es accesible desde internet y solo funciona como motor de automatizaci√≥n interno.

```
Frontend (Puerto 3000) ‚Üí N8N Webhooks (Puerto 5678) ‚Üí OpenAI API ‚Üí Gmail API
      ‚Üì                           ‚Üì                        ‚Üì           ‚Üì
   Nginx Proxy              Procesamiento             Transcripci√≥n  Email
  (obratec.app)              Workflows                 y An√°lisis    Autom√°tico
```

## üöÄ Despliegue en VPS

### Prerequisitos

- VPS con Ubuntu/Debian
- Docker y Docker Compose instalados
- Dominio configurado (obratec.app)
- Acceso SSH al servidor

### 1. Clonaci√≥n del Repositorio

```bash
git clone https://github.com/tu-usuario/informe_obra.git
cd informe_obra
```

### 2. Configuraci√≥n de Variables de Entorno

```bash
# Copiar archivo de ejemplo
cp .env.vps.example .env

# Editar variables de entorno
nano .env
```

Variables requeridas:
```env
# URLs de la aplicaci√≥n
FRONTEND_URL=https://obratec.app
N8N_URL=https://n8n.obratec.app
WEBHOOK_URL=https://obratec.app/webhook/form-obra

# Configuraci√≥n N8N
N8N_HOST=n8n.obratec.app
N8N_PROTOCOL=https
N8N_PORT=443

# APIs
OPENAI_API_KEY=tu_clave_openai
GMAIL_CLIENT_ID=tu_client_id_gmail
GMAIL_CLIENT_SECRET=tu_client_secret_gmail
GMAIL_REFRESH_TOKEN=tu_refresh_token_gmail

# Email configuraci√≥n
FROM_EMAIL=sistema@obratec.app
TO_EMAIL=informes@empresa.com
```

### 3. Despliegue Autom√°tico

```bash
# Dar permisos de ejecuci√≥n
chmod +x deploy-vps.sh

# Ejecutar script de despliegue
./deploy-vps.sh
```

### 4. Configuraci√≥n de Nginx

```bash
# Copiar configuraci√≥n de Nginx
sudo cp nginx.conf.example /etc/nginx/sites-available/obratec
sudo ln -s /etc/nginx/sites-available/obratec /etc/nginx/sites-enabled/

# Obtener certificados SSL
sudo certbot --nginx -d obratec.app -d n8n.obratec.app

# Reiniciar Nginx
sudo systemctl restart nginx
```

## üìã Configuraci√≥n Post-Despliegue

### 1. Importar Workflows N8N

1. Acceder a https://n8n.obratec.app
2. Ir a `Workflows` ‚Üí `Import from File`
3. Cargar `n8n/workflows/informe_obra_n8n_workflow.json`
4. Activar el workflow

### 2. Verificar Sistema

```bash
# Ejecutar script de verificaci√≥n (Windows PowerShell)
./final-setup.ps1

# O verificar manualmente
curl -X POST https://obratec.app/webhook/form-obra \
  -H "Content-Type: application/json" \
  -d '{"test": "true"}'
```

## üìÅ Estructura del Proyecto

```
informe_obra/
‚îú‚îÄ‚îÄ public/                     # Frontend web
‚îÇ   ‚îú‚îÄ‚îÄ index.html             # Formulario principal
‚îÇ   ‚îú‚îÄ‚îÄ styles.css             # Estilos
‚îÇ   ‚îî‚îÄ‚îÄ script.js              # JavaScript cliente
‚îú‚îÄ‚îÄ n8n/
‚îÇ   ‚îî‚îÄ‚îÄ workflows/             # Workflows N8N
‚îÇ       ‚îî‚îÄ‚îÄ informe_obra_n8n_workflow.json
‚îú‚îÄ‚îÄ docker-compose.vps.yml     # Configuraci√≥n Docker VPS
‚îú‚îÄ‚îÄ deploy-vps.sh              # Script de despliegue
‚îú‚îÄ‚îÄ nginx.conf.example         # Configuraci√≥n Nginx
‚îú‚îÄ‚îÄ server.js                  # Servidor Node.js
‚îú‚îÄ‚îÄ Dockerfile                 # Imagen Docker
‚îî‚îÄ‚îÄ .env.vps.example          # Variables de entorno template
```

## üîß Desarrollo Local

### Instalaci√≥n

```bash
# Instalar dependencias
npm install

# Configurar variables de entorno
cp .env.example .env
# Editar .env con tus claves

# Ejecutar en desarrollo
npm start
```

### Docker Local

```bash
# Construir y ejecutar
docker-compose up --build

# Acceder a:
# - Frontend: http://localhost:3000
# - N8N: http://localhost:5678
```

## üêõ Soluci√≥n de Problemas

### Verificar Estado de Contenedores

```bash
docker ps
docker logs obratec-app
docker logs obratec-n8n
```

### Verificar Nginx

```bash
sudo nginx -t
sudo systemctl status nginx
sudo journalctl -u nginx -f
```

### Verificar SSL

```bash
sudo certbot certificates
sudo certbot renew --dry-run
```

### Logs de la Aplicaci√≥n

```bash
# Ver logs en tiempo real
docker logs -f obratec-app
docker logs -f obratec-n8n

# Ver logs espec√≠ficos
docker exec -it obratec-app cat /var/log/app.log
```

## üìß Configuraci√≥n de Email

### Gmail OAuth Setup

1. Crear proyecto en Google Cloud Console
2. Habilitar Gmail API
3. Crear credenciales OAuth 2.0
4. Obtener refresh token usando:

```bash
# Usar herramienta OAuth Playground o script personalizado
curl -X POST https://oauth2.googleapis.com/token \
  -d "client_id=TU_CLIENT_ID" \
  -d "client_secret=TU_CLIENT_SECRET" \
  -d "refresh_token=TU_REFRESH_TOKEN" \
  -d "grant_type=refresh_token"
```

## üîê Seguridad

- ‚úÖ HTTPS con certificados Let's Encrypt
- ‚úÖ Variables de entorno para credenciales
- ‚úÖ Network isolation en Docker
- ‚úÖ Reverse proxy con Nginx
- ‚úÖ Rate limiting en Nginx (opcional)

## üìä Monitoreo

### Comandos √ötiles

```bash
# Estado del sistema
docker stats
df -h
free -h

# Logs de acceso Nginx
sudo tail -f /var/log/nginx/access.log

# Monitoreo de puertos
sudo netstat -tlnp | grep :443
sudo netstat -tlnp | grep :80
```

## üîÑ Actualizaciones

```bash
# Actualizar c√≥digo
git pull origin main

# Reconstruir y desplegar
docker-compose -f docker-compose.vps.yml down
docker-compose -f docker-compose.vps.yml up --build -d

# Verificar actualizaci√≥n
curl -I https://obratec.app
```

## üìû Soporte

Para problemas o consultas:

1. Revisar logs de contenedores
2. Verificar configuraci√≥n de DNS
3. Comprobar certificados SSL
4. Validar variables de entorno
5. Revisar workflows N8N

## üìÑ Licencia

MIT License - Ver archivo LICENSE para m√°s detalles.

---

**üîó Enlaces Importantes:**
- [Documentaci√≥n N8N](https://docs.n8n.io/)
- [API OpenAI](https://platform.openai.com/docs/)
- [Gmail API](https://developers.google.com/gmail/api)
- [Let's Encrypt](https://letsencrypt.org/)
- [Docker Compose](https://docs.docker.com/compose/)