<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Informe semanal de obra</title>

  <!-- PicoCSS (CDN) -->
  <link rel="stylesheet"
        href="https://cdn.jsdelivr.net/npm/@picocss/pico@1.5.7/css/pico.min.css" />
  <!-- Nuestro CSS -->
  <link rel="stylesheet" href="css/style.css" />

  <!-- Favicon -->    
  <link rel="icon" type="image/webp" href="assets/favicon.webp">
  <link rel="apple-touch-icon" sizes="180x180" href="assets/favicon.webp">
  <link rel="shortcut icon" href="assets/favicon.webp">
  <link rel="manifest" href="assets/site.webmanifest">
<meta name="theme-color" content="#3B8C88">
<meta name="apple-mobile-web-app-status-bar-style" content="#3B8C88">

</head>

<body>
  <main class="container">
    <h1>Informe semanal</h1>

    <form id="obraForm" autocomplete="off">
      <label>
        Email
        <input type="email" name="email" placeholder="Email donde te llegar√° el informe" required />
      </label>

      <label>
        Proyecto
        <input name="projectName" placeholder="Nombre obra" required />
      </label>

      <label>
        Fecha
        <input type="date" name="date" required />
      </label>

      <label>
        Avance (%)  
        <input type="number" name="advance" min="0" max="100" required />
      </label>

      <label>
        Observaciones
        <textarea name="observations" rows="3"></textarea>
      </label>

      <label>
        Incidencias
        <textarea name="incidences" rows="3"></textarea>
      </label>

      <!-- Descomenta para fotos
      <label>
        Fotos (m√°x 3)
        <input type="file" name="photos" accept="image/*" multiple capture="environment" />
      </label>
      -->

      <div class="audio-recorder">
        <label>Observaciones de voz:</label>
        <div class="recorder-controls">
          <button type="button" id="startRecording" class="outline">üéôÔ∏è Iniciar grabaci√≥n</button>
          <button type="button" id="stopRecording" class="outline" disabled>‚èπÔ∏è Detener</button>
          <span id="recordingStatus"></span>
        </div>
        <audio id="audioPlayback" controls style="display:none; width:100%; margin-top:10px;"></audio>
        <!-- Este campo oculto almacenar√° el audio como base64 -->
        <input type="hidden" name="audioData" id="audioData">
      </div>
        <button type="submit">Enviar informe</button>
    </form>

    <p id="status"></p>
    
    <!-- Panel de diagn√≥stico temporal -->
    <details style="margin-top: 2rem; border: 1px solid #ccc; padding: 1rem; border-radius: 5px;">
      <summary>üîß Diagn√≥stico del Sistema</summary>
      <div style="margin-top: 1rem;">
        <button type="button" onclick="checkHealth()" style="margin: 0.5rem;">Check Health</button>
        <button type="button" onclick="checkN8N()" style="margin: 0.5rem;">Check N8N</button>
        <button type="button" onclick="testWebhook()" style="margin: 0.5rem;">Test Webhook</button>
        <div id="debugOutput" style="margin-top: 1rem; padding: 1rem; background: #f5f5f5; font-family: monospace; white-space: pre-wrap; max-height: 200px; overflow-y: auto;"></div>
      </div>
    </details>
  </main>

  <script src="js/script.js"></script>
  <script src="js/audioRecord.js"></script>
  
  <script>
    // Funciones de diagn√≥stico temporal
    function log(message) {
      const output = document.getElementById('debugOutput');
      output.textContent += new Date().toLocaleTimeString() + ': ' + message + '\n';
      output.scrollTop = output.scrollHeight;
    }
    
    async function checkHealth() {
      try {
        const response = await fetch('/health');
        const data = await response.json();
        log('‚úÖ Health check: ' + JSON.stringify(data, null, 2));
      } catch (error) {
        log('‚ùå Health check error: ' + error.message);
      }
    }
    
    async function checkN8N() {
      try {
        const response = await fetch('/debug/n8n');
        const data = await response.json();
        log('üîç N8N Status: ' + JSON.stringify(data, null, 2));
      } catch (error) {
        log('‚ùå N8N check error: ' + error.message);
      }
    }
    
    async function testWebhook() {
      try {
        const testData = {
          projectName: 'Test Project',
          date: new Date().toISOString().split('T')[0],
          advance: '50%',
          observations: 'Test observation',
          incidences: 'Test incidence'
        };
        
        const response = await fetch('/test-webhook', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(testData)
        });
        
        const result = await response.json();
        log('üß™ Test webhook result: ' + JSON.stringify(result, null, 2));
      } catch (error) {
        log('‚ùå Test webhook error: ' + error.message);
      }
    }
  </script>

</body>
</html>
